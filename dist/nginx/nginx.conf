proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache_www:30m max_size=500m inactive=30d;
server_tokens off;

server {
    listen 443 ssl;
    listen 80;
    ssl_certificate     ${KANJIMI_NGINX_CERTIFICATE_CRT};
    ssl_certificate_key ${KANJIMI_NGINX_CERTIFICATE_KEY};
    proxy_set_header Host $http_host;

    if ($scheme != https) {
        return 301 https://$http_host$request_uri;
    }

    ${KANJIMI_NGINX_COMMENT_FORCE_DOMAIN}if ($http_host != ${KANJIMI_NGINX_DOMAIN}) {
    ${KANJIMI_NGINX_COMMENT_FORCE_DOMAIN}    return 301 https://${KANJIMI_NGINX_DOMAIN}$request_uri;
    ${KANJIMI_NGINX_COMMENT_FORCE_DOMAIN}}

    root /kanjimi/www;
    expires ${KANJIMI_NGINX_CACHE_DURATION};

    location /app {
        rewrite ^/app/(.*)$ /app/index.html break;
    }

    location /health-check {
        return 200
    }

    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}location /test-pages/ {
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}    add_header Content-Type 'text/html; charset=utf-8';
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}}
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}location /test-pages/infinite-redirect-loop {
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}    return 301 https://$http_host/test-pages/infinite-redirect-loop;
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}}
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}location /test-pages/redirect-to-landing-page-examples {
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}    return 301 https://$http_host/test-pages/landing-page-examples.html;
    ${KANJIMI_NGINX_COMMENT_TEST_PAGES}}

    location /api/ {
        proxy_cache off;
        expires off;
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://${KANJIMI_NGINX_UPSTREAM};
    }
}
