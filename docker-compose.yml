version: '3.5'

services:
  database:
    image: postgres:11
    restart: on-failure
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test
    ports:
      - "5432:5432"
    volumes:
      - database:/var/lib/postgresql/data
  server:
    image: node:11
    restart: on-failure
    working_dir: /app
    environment:
      - KANJIMI_DATABASE_HOST=database
      - KANJIMI_DATABASE_PORT=5432
      - KANJIMI_DATABASE_DATABASE=test
      - KANJIMI_DATABASE_USER=test
      - KANJIMI_DATABASE_PASSWORD=test
      - KANJIMI_ALLOW_TEST_PAGES=true
      - KANJIMI_SMTP_HOST=smtp
      - KANJIMI_SMTP_PORT=25
      - KANJIMI_SMTP_SECURE=false
      #- KANJIMI_SMTP_USER=
      #- KANJIMI_SMTP_PASS=
      - KANJIMI_API_URL=http://localhost:3000/api
      - KANJIMI_WWW_URL=http://localhost:3000/www
    command: >
      bash -c "
        ./node_modules/.bin/ts-node -r tsconfig-paths/register ./src/Server/migrate.ts &
        ./node_modules/.bin/nodemon -e ts -w ./src --ignore ./src/Extension --ignore ./src/WebApp -x ./node_modules/.bin/ts-node -r tsconfig-paths/register src/Server/server.ts
      "
    ports:
      - "3000:3000"
    volumes:
      - $PWD:/app
      - mails:/tmp/mails
  watch_extension_content:
    image: node:11
    restart: on-failure
    working_dir: /app
    environment:
      - KANJIMI_API_URL=http://localhost:3000/api
      - KANJIMI_WWW_URL=http://localhost:3000/www
    command: >
      bash -c "
        ./node_modules/.bin/webpack --color --config=webpack.extensionContent.config.js --build;
        ./node_modules/.bin/webpack --color --config=webpack.extensionContent.config.js --watch
      "
    volumes:
      - $PWD:/app
  watch_web_app:
    image: node:11
    restart: on-failure
    working_dir: /app
    environment:
      - KANJIMI_API_URL=http://localhost:3000/api
      - KANJIMI_WWW_URL=http://localhost:3000/www
    command: >
      bash -c "
        ./node_modules/.bin/webpack --color --config=webpack.webApp.config.js --build;
        ./node_modules/.bin/webpack --color --config=webpack.webApp.config.js --watch
      "
    volumes:
      - $PWD:/app
  smtp:
    image: hmlio/spamsink
    restart: on-failure
    environment:
      - SINK_PORT=25
      - SINK_HOSTNAME=smtp
    volumes:
      - mails:/opt/spamsink/mails
volumes:
  database:
  mails:
